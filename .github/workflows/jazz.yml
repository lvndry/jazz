name: Jazz AI

on:
  # TODO: Switch to pull_request_target once this workflow is merged to main
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

env:
  PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
  PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Jazz
        run: npm install -g jazz-ai

      - name: Setup Jazz agent and workflow
        run: |
          mkdir -p .jazz/agents workflows/code-review
          cp .github/jazz/agents/ci-reviewer.json .jazz/agents/
          cp .github/jazz/workflows/code-review/WORKFLOW.md workflows/code-review/

      - name: Run code review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CI: "true"
          JAZZ_DISABLE_CATCH_UP: "1"
        run: jazz workflow run code-review --auto-approve --headless --agent ci-reviewer --quiet 2>/dev/null | tee /tmp/jazz-review.txt

      - name: Post review comments
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const output = fs.readFileSync('/tmp/jazz-review.txt', 'utf8');

            // Extract the last ```json ... ``` block from the output
            const jsonBlocks = [...output.matchAll(/```json\s*\n([\s\S]*?)```/g)];
            if (jsonBlocks.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## Jazz Code Review\n\n${output.slice(-60000) || '_No output from review._'}`
              });
              return;
            }

            const comments = JSON.parse(jsonBlocks[jsonBlocks.length - 1][1].trim());

            if (!Array.isArray(comments) || comments.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## Jazz Code Review\n\nNo issues found.`
              });
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              commit_id: context.payload.pull_request.head.sha,
              event: 'COMMENT',
              body: `## Jazz Code Review\n\nFound ${comments.length} comment(s).`,
              comments: comments.map(c => ({
                path: c.path,
                line: c.line,
                ...(c.start_line != null && { start_line: c.start_line, start_side: c.start_side || c.side || 'RIGHT' }),
                side: c.side || 'RIGHT',
                body: c.body
              }))
            });

  bugbot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Jazz
        run: npm install -g jazz-ai

      - name: Setup Jazz agent and workflow
        run: |
          mkdir -p .jazz/agents workflows/bugbot
          cp .github/jazz/agents/ci-bugbot.json .jazz/agents/
          cp .github/jazz/workflows/bugbot/WORKFLOW.md workflows/bugbot/

      - name: Run bugbot
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CI: "true"
          JAZZ_DISABLE_CATCH_UP: "1"
        run: jazz workflow run bugbot --auto-approve --headless --agent ci-bugbot --quiet 2>/dev/null | tee /tmp/jazz-bugbot.txt

      - name: Post bug report comments
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const output = fs.readFileSync('/tmp/jazz-bugbot.txt', 'utf8');

            // Extract the last ```json ... ``` block from the output
            const jsonBlocks = [...output.matchAll(/```json\s*\n([\s\S]*?)```/g)];
            if (jsonBlocks.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## Jazz Bug Detection\n\n${output.slice(-60000) || '_No output from bugbot._'}`
              });
              return;
            }

            const comments = JSON.parse(jsonBlocks[jsonBlocks.length - 1][1].trim());

            if (!Array.isArray(comments) || comments.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## Jazz Bug Detection\n\nNo bugs found.`
              });
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              commit_id: context.payload.pull_request.head.sha,
              event: 'COMMENT',
              body: `## Jazz Bug Detection\n\nFound ${comments.length} potential issue(s).`,
              comments: comments.map(c => ({
                path: c.path,
                line: c.line,
                ...(c.start_line != null && { start_line: c.start_line, start_side: c.start_side || c.side || 'RIGHT' }),
                side: c.side || 'RIGHT',
                body: c.body
              }))
            });
